@page "/admin"
@inject IUserService UserService
@inject IUserSession UserSession
@inject NavigationManager NavigationManager
@using Store_Manager.Services.UserService
@using Store_Manager.Services.UserService.UserRoles
@using Store_Manager.ViewModels

<PageTitle>Admin</PageTitle>

<h1>Admin</h1>

@if (errorMessage is not null)
{
    <div class="alert alert-danger alert-dismissible">
        @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
    </div>
}

<SelectableList TItem="UserVm"
                Items="users"
                Columns="userColumns"
                @bind-SelectedItem="selectedUser" />

<div class="d-flex gap-2 mt-2">
    <button class="btn btn-primary" @onclick="OpenCreateUserModal">Add User</button>
    @if (selectedUser is not null && selectedUser.Email != "admin@optikit.dk")
    {
        <button class="btn btn-outline-danger" @onclick="OpenDeleteUserModal">Delete</button>
    }
</div>

<!-- Create User Modal -->
@if (showCreateUserModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal show d-block">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add User</h5>
                    <button class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input class="form-control" @bind="formName" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input class="form-control" type="email" @bind="formEmail" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input class="form-control" type="password" @bind="formPassword" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" @bind="formRole">
                            <option value="@UserRole.Support">Support</option>
                            <option value="@UserRole.Administrator">Administrator</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                    <button class="btn btn-primary" @onclick="CreateUser">Create</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Delete User Modal -->
@if (showDeleteUserModal && selectedUser is not null)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal show d-block">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete User</h5>
                    <button class="btn-close" @onclick="CloseModals"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete <strong>@selectedUser.Name</strong>?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseModals">Cancel</button>
                    <button class="btn btn-danger" @onclick="DeleteUser">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<UserVm> users = [];
    private UserVm? selectedUser;
    private string? errorMessage;

    private bool showCreateUserModal;
    private bool showDeleteUserModal;

    private string formName = string.Empty;
    private string formEmail = string.Empty;
    private string formPassword = string.Empty;
    private UserRole formRole = UserRole.Support;

    private readonly List<ColumnDefinition<UserVm>> userColumns =
    [
        new("Name", u => u.Name),
        new("Email", u => u.Email),
        new("Role", u => u.Role.ToString()),
        new("Created On", u => u.CreatedOn.ToString("g")),
    ];

    protected override async Task OnInitializedAsync()
    {
        if (!UserSession.IsAdmin())
        {
            NavigationManager.NavigateTo("/");
            return;
        }

        await LoadUsers();
    }

    private async Task LoadUsers() => users = await UserService.GetAllUsersAsync();

    private void CloseModals()
    {
        showCreateUserModal = false;
        showDeleteUserModal = false;
    }

    private void OpenDeleteUserModal() => showDeleteUserModal = true;

    private async Task DeleteUser()
    {
        if (selectedUser is null) return;
        try
        {
            errorMessage = null;
            await UserService.DeleteUserAsync(selectedUser.Id);
            selectedUser = null;
            await LoadUsers();
            CloseModals();
        }
        catch (InvalidOperationException ex) { errorMessage = ex.Message; }
    }

    private void OpenCreateUserModal()
    {
        formName = string.Empty;
        formEmail = string.Empty;
        formPassword = string.Empty;
        formRole = UserRole.Support;
        showCreateUserModal = true;
    }

    private async Task CreateUser()
    {
        try
        {
            errorMessage = null;
            await UserService.CreateUserAsync(formName, formEmail, formPassword, formRole);
            await LoadUsers();
            CloseModals();
        }
        catch (InvalidOperationException ex) { errorMessage = ex.Message; }
    }
}
